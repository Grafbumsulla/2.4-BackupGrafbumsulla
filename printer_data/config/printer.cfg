# This file contains common pin mappings for the BigTreeTech Octopus V1.

# See docs/Config_Reference.md for a description of parameters.

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_3A0017000550314D35323820-if00
canbus_uuid: 1e5877383892

[mcu orbitoolO2]
#serial:/dev/serial/by-id/usb-Klipper_stm32f042x6_OrbitoolO2-if00
serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_0C001A000243304353373720-if00
baud: 250000
restart_method: command

##--------------------------------------------------------------------

[temperature_sensor octopus]
## Spider Temps
sensor_type: temperature_mcu
max_temp: 100

[temperature_sensor raspberry_pi]
## Pi Temps
sensor_type: temperature_host
max_temp: 100

## STM32 MCU temp
[temperature_sensor toolboard]
sensor_type: temperature_mcu
sensor_mcu: orbitoolO2
min_temp: 0
max_temp: 100


[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[include mainsail.cfg]
[display_status]
[pause_resume]

[pause_resume]

#[mcu rpi]
#serial: /tmp/klipper_host_mcu

#[adxl345]
#cs_pin: rpi:None

[include macros.cfg]

[include motor_database.cfg]

#[include led_progress.cfg]

[display_status]

[include mainsail.cfg]

[include Adaptive_Mesh.cfg]


[exclude_object]



[printer]
kinematics: corexy
max_velocity: 800
max_accel: 15000 #
max_z_velocity: 35 #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 500
square_corner_velocity: 14

[lis2dw]
cs_pin: orbitoolO2:PA4
spi_bus: spi1
axes_map: y, z, x

[resonance_tester]
accel_chip: lis2dw
probe_points: 152.5, 152.5, 35 
min_freq: 10
max_freq: 200



    
[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^EBBCan: PB8 #tmc2209_stepper_x:virtual_endstop 
position_min: 0
##--------------------------------------------------------------------

##  Uncomment below for 250mm build
#position_endstop: 250
#position_max: 250

##  Uncomment for 300mm build
position_endstop: 305
position_max: 305  ###Endstop 93mm weg=207

##  Uncomment for 350mm build
#position_endstop: 350
#position_max: 350

##--------------------------------------------------------------------
homing_speed: 200  #Max 100
homing_retract_dist: 0
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc5160 stepper_x] #[tmc2209 stepper_x]
cs_pin: PD11
spi_software_sclk_pin: PA5
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
run_current: 1.9
sense_resistor: 0.022 #0.110
#stealthchop_threshold: 999999
interpolate: true

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: PG9 #tmc2209_stepper_y:virtual_endstop
position_min: 0

position_endstop: 302
position_max: 302
##--------------------------------------------------------------------
homing_speed: 200 #Max 100
homing_retract_dist: 0
homing_positive_dir: true

[tmc5160 stepper_y]
cs_pin: PC4
spi_software_sclk_pin: PA5
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
run_current: 1.9
sense_resistor: 0.022 #0.110
#stealthchop_threshold: 999999
interpolate: true
 
#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0.5
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 0
position_max: 260
position_min: -1.0

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC6
run_current: 1.0
sense_resistor: 0.110
#stealthchop_threshold: 0.0
interpolate: true


[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_C3CA5C864E4B333448202020FF0A1507-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 28.244 # update with offset from nozzle on your machine
mesh_main_direction: X
mesh_runs: 2
contact_max_hotend_temperature: 180
home_xy_position:153,151
home_z_hop: 5
home_z_hop_speed: 30
home_xy_move_speed: 300
home_method: contact # use proximity for induction homing
home_method_when_homed: proximity # after initial calibration use induction
home_autocalibrate: unhomed # contact will calibrate beacon on first home


##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PC7
run_current: 1.0
sense_resistor: 0.110
#stealthchop_threshold: 0.0
interpolate: true

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32


##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PF2
run_current: 1.0
sense_resistor: 0.110
#stealthchop_threshold: 0.0
interpolate: true

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32


##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: PE4
run_current: 1.0
sense_resistor: 0.110
#stealthchop_threshold: 0.0
interpolate: true




#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
full_steps_per_rotation: 200
#gear_ratio: 50:10 #for standard 10t motor
rotation_distance:  3.9 #5.3238 #5.7 #4.637 #22.67895
#rotation_distance: 4.6376 #8116 #4.647 # 19,8 restmessung Orbiter 2.0
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
max_extrude_only_distance: 780
max_extrude_only_velocity: 10000
max_extrude_cross_section: 500
pressure_advance: 0.0313 #0.025 #to be calibrated
pressure_advance_smooth_time: 0.03

sensor_type: PT1000 #MAX31865 # #ATC Semitec 104NT-4-R025H42G #Generic 3950  
sensor_pin: EBBCan: PA3 #EBBCan: PA4 
pullup_resistor: 2200

#spi_bus: spi1
#rtd_nominal_r: 1000
#rtd_reference_r: 4300
#rtd_num_of_wires: 2

#control: pid
#pid_Kp: 19.554
#pid_Ki: 1.331
#pid_Kd: 109.257
min_temp: -270
max_temp: 435



[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: false
run_current: 0.58
sense_resistor: 0.110
#stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.4
retract_speed: 40
unretract_extra_length: 0.00
unretract_speed: 45

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
##  SSR Pin - HE1
##  Thermistor - TB
##  Uncomment the following line if using the default SSR wiring from the docs site
#heater_pin: PA3
##  Other wiring guides may use BED_OUT to control the SSR. Uncomment the following line for those cases
heater_pin: PA1
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for Keenovo heaters
sensor_type: Generic 3950
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.8
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769


#####################################################################
#   Fan Control
#####################################################################


[fan]
##  Print Cooling Fan - FAN0
pin: EBBCan: PA1
kick_start_time: 0.2
##  Depending on your fan, you may need to increase this value
##  if your fan will not start. Can change cycle_time (increase)
##  if your fan is not able to slow down effectively
off_below: 0.10

#[controller_fan hotend]
#pin: EBBCan: PA1
#heater: extruder

[heater_fan heatbreakfan]
pin:EBBCan: PA0
max_power: 1.0
#shutdown_speed:
cycle_time: 0.010
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.
heater: extruder
#   Name of the config section defining the heater that this fan is
#   associated with. If a comma separated list of heater names is
#   provided here, then the fan will be enabled when any of the given
#   heaters are enabled. The default is "extruder".
#   A temperature (in Celsius) that the heater must drop below before
#   the fan is disabled. The default is 50 Celsius.
fan_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when its associated heater is enabled. The default
#   is 1.0
tachometer_pin: ^EBBCan: PB9

[controller_fan controller_fan]
##  Controller fan - FAN2
pin: PD12 
kick_start_time: 0.5
heater: heater_bed
max_power: 0.6

[controller_fan controller_fan2]
##  Controller fan - FAN2
pin: PD13 
kick_start_time: 0.5
heater: heater_bed
max_power: 0.6


[temperature_fan Chamber]
##  Exhaust fan - FAN3
pin: PD14
max_power: 0.6
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time:0.01
off_below:0.1
sensor_pin: PF4
sensor_type: Generic 3950
min_temp: 0
max_temp: 90
target_temp: 65.0
control: watermark
gcode_id: C

[heater_fan Nevermore]
## Nevermore - FAN5 on Octopus
## Adjust if you use a different board or a different terminal.
pin: PD15
heater: heater_bed 
heater_temp: 80.0


[delayed_gcode filter_off]
gcode:
    SET_FAN_SPEED FAN=Nevermore SPEED=0

[gcode_macro TOGGLE_NEVERMORE]
gcode:
    {% if printer['fan_generic Nevermore'].speed > 0 %}
      SET_FAN_SPEED FAN=Nevermore SPEED=0
    {% else %}
      SET_FAN_SPEED FAN=Nevermore SPEED=1
    {% endif %}
#####################################################################
#   LED Control
#####################################################################

[neopixel caselight]
pin: PB0
chain_count: 57
#   The pin connected to the neopixel. This parameter must be
#   provided.
#   The number of Neopixel chips that are "daisy chained" to the
#   provided pin. The default is 1 (which indicates only a single
#   Neopixel is connected to the pin).
color_order: GRB
#   Set the pixel order required by the LED hardware (using a string
#   containing the letters R, G, B, W with W optional). Alternatively,
#   this may be a comma separated list of pixel orders - one for each
#   LED in the chain. The default is GRB.
initial_RED: 0.7
initial_GREEN: 0.7
initial_BLUE: 0.7
#initial_WHITE: 0.0
#   See the "led" section for information on these parameters.

## Chamber Lighting - HE2 Connector (Optional)
#[output_pin caselight]
#pin: PB10
#pwm:true
#shutdown_value: 0
#value:1
#cycle_time: 0.01

[neopixel sb_leds]
pin: EBBCan:PD3
chain_count: 3
#   The pin connected to the neopixel. This parameter must be
#   provided.
#   The number of Neopixel chips that are "daisy chained" to the
#   provided pin. The default is 1 (which indicates only a single
#   Neopixel is connected to the pin).
color_order:  GRBW #GRBW
#   Set the pixel order required by the LED hardware (using a string
#   containing the letters R, G, B, W with W optional). Alternatively,
#   this may be a comma separated list of pixel orders - one for each
#   LED in the chain. The default is GRB.
#initial_RED: 0.0
#initial_GREEN: 0.0
initial_BLUE: 0.0
initial_WHITE: 0.8
##   See the "led" section for information on these parameters.


#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 6000

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.



[quad_gantry_level]

    
##  Gantry Corners for 300mm Build
##  Uncomment for 300mm build
gantry_corners:
   -60,-10
   360,370
   
  #Probe points
points:
        30,0
        30,260
        275,260
        275,0

  
#points:
#  20,20
#  20,267
#  285,267
#  285,20



#--------------------------------------------------------------------
speed: 600
horizontal_move_z: 2
retries: 10
retry_tolerance: 0.002
max_adjust: 15


[bed_mesh]
mesh_min: 24,35
mesh_max: 291,269
speed: 350
horizontal_move_z: 2
probe_count: 15,15
algorithm: bicubic
#   The z position in which fade should converge. When this value is
#   set to a non-zero value it must be within the range of z-values in
#   the mesh. Users that wish to converge to the z homing position
#   should set this to 0. Default is the average z value of the mesh.
#move_check_distance: 3
#   The distance (in mm) along a move to check for split_delta_z.
#   This is also the minimum length that a move can be split. Default
#   is 5.0.
#split_delta_z: 0.01
#   The amount of Z difference (in mm) along a move that will
#   trigger a split. Default is .025.
#mesh_pps: 4,4
#   A comma separated pair of integers (X,Y) defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed
#   point. The user may enter a single value which will be applied
#   to both axes.  Default is 2,2.
#bicubic_tension: 0.2
#   When using the bicubic algorithm the tension parameter above
#   may be applied to change the amount of slope interpolated.
#   Larger numbers will increase the amount of slope, which
#   results in more curvature in the mesh. Default is .2.





########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#####################################################################
#   Displays
#####################################################################

##  Uncomment the display that you have
#--------------------------------------------------------------------

#[display]
##  RepRapDiscount 128x64 Full Graphic Smart Controller
#lcd_type: st7920
#cs_pin: EXP1_4
#sclk_pin: EXP1_5
#sid_pin: EXP1_3
#menu_timeout: 40
#encoder_pins: ^EXP2_5, ^EXP2_3
#click_pin: ^!EXP1_2

#[output_pin beeper]
#pin: EXP1_1

#--------------------------------------------------------------------

#[display]
##  mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: EXP1_3
#a0_pin: EXP1_4
#rst_pin: EXP1_5
#encoder_pins: ^EXP2_5, ^EXP2_3
#click_pin: ^!EXP1_2
#contrast: 63
#spi_software_miso_pin: EXP2_1
#spi_software_mosi_pin: EXP2_6
#spi_software_sclk_pin: EXP2_2

#[neopixel btt_mini12864]
##  To control Neopixel RGB in mini12864 display
#pin: EXP1_6
#chain_count: 3
#initial_RED: 1.0
#initial_GREEN: 0.0
#initial_BLUE: 0.0
#color_order: RGB

##  Set RGB values on boot up for each Neopixel. 
##  Index 1 = display, Index 2 and 3 = Knob
#[delayed_gcode setdisplayneopixel]
#initial_duration: 1
#gcode:
#        SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
#        SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
#        SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

#--------------------------------------------------------------------



#####################################################################
#   Tuning 
#####################################################################

[autotune_tmc stepper_x]
motor: ldo-42sth48-2504ac
tuning_goal: performance
voltage: 48
[autotune_tmc stepper_y]
motor: ldo-42sth48-2504ac
tuning_goal: performance
voltage: 48

[autotune_tmc stepper_z]
motor: moons-ms17hd6p420I-04
tuning_goal: auto
voltage: 24
[autotune_tmc stepper_z1]
motor: moons-ms17hd6p420I-04
tuning_goal: auto
voltage: 24
[autotune_tmc stepper_z2]
motor: moons-ms17hd6p420I-04
tuning_goal: auto
voltage: 24
[autotune_tmc stepper_z3]
motor: moons-ms17hd6p420I-04
tuning_goal: auto
voltage: 24

#[autotune_tmc extruder]
#motor: ldo-36sth20-1004ahg
#tuning_goal: auto
#voltage: 24

[input_shaper]
### 2022-12-16
shaper_freq_x: 67.8 #63.6 #49.6ei
shaper_type_x: mzv
shaper_freq_y: 52.4
shaper_type_y: mzv

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 46.078
#*# pid_ki = 1.828
#*# pid_kd = 290.291
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.635
#*# pid_ki = 3.446
#*# pid_kd = 87.022
#*#
#*# [beacon model default]
#*# model_coef = 1.5885708863326056,
#*# 	  1.9140650672317605,
#*# 	  0.7437150400873761,
#*# 	  0.3470565946469893,
#*# 	  0.2785820817609423,
#*# 	  0.14951481784110626,
#*# 	  -0.17756442009711929,
#*# 	  -0.09099581008493587,
#*# 	  0.16908827677256058,
#*# 	  0.08427304080629607
#*# model_domain = 3.275079886556946e-07,3.353202038638456e-07
#*# model_range = 0.200417,5.000417
#*# model_temp = 47.842033
#*# model_offset = 0.04000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.039177, 0.034673, 0.019644, 0.001211, -0.005181, 0.005581
#*# 	  0.036824, 0.027205, 0.012648, -0.007113, -0.015044, -0.008776
#*# 	  0.042737, 0.035855, 0.017583, -0.004212, -0.009702, -0.006448
#*# 	  0.024532, 0.023811, 0.005384, -0.013323, -0.018904, -0.013531
#*# 	  0.031019, 0.030411, 0.015447, 0.002122, -0.005379, -0.005211
#*# x_count = 6
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 109.5
#*# max_x = 195.5
#*# min_y = 121.0
#*# max_y = 181.0
